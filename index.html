<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ИГЭУ САПР</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/flaticon.css">
    <script src="js/jquery-2.1.4.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/svg.min.js"></script>
    <script src="js/lightgl.js"></script>
    <script src="js/csg.js"></script>
</head>
<body>
<!-- Modal -->
<div class="modal fade" id="cubeModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title">Создать паралепипед</h4>
            </div>
            <div class="modal-body">
                <div class="col-md-3"></div>
                <div class="col-md-9">
                    <div class="row">
                        <div class="form-horizontal">
                            <div class="form-group">
                                <label class="col-sm-2 control-label">Ширина</label>
                                <div class="col-sm-10">
                                    <input placeholder="0" class="form-control width" name="width">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">Высота</label>
                                <div class="col-sm-10">
                                    <input placeholder="0" class="form-control height" name="height">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">Глубина</label>
                                <div class="col-sm-10">
                                    <input placeholder="0" class="form-control depth" name="depth">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="clearfix"></div>
            </div>
            <div class="modal-footer">
                <!--<button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>-->
                <button type="button" class="btn btn-primary accept">Создать</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="cylinderModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title">Создать цилиндр</h4>
            </div>
            <div class="modal-body">
                <div class="col-md-3"></div>
                <div class="col-md-9">
                    <div class="row">
                        <div class="form-horizontal">
                            <div class="form-group">
                                <label class="col-sm-2 control-label">Высота</label>
                                <div class="col-sm-10">
                                    <input placeholder="0" class="form-control width" name="width">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">Радиус</label>
                                <div class="col-sm-10">
                                    <input placeholder="0" class="form-control radius" name="radius1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="clearfix"></div>
            </div>
            <div class="modal-footer">
                <!--<button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>-->
                <button type="button" class="btn btn-primary accept">Создать</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="coneModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title">Создать конус</h4>
            </div>
            <div class="modal-body">
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Высота</label>
                            <div class="col-sm-10">
                                <input placeholder="0" class="form-control width" name="width">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Радиус 1</label>
                            <div class="col-sm-10">
                                <input placeholder="0" class="form-control radius1" name="radius1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Радиус 2</label>
                            <div class="col-sm-10">
                                <input placeholder="0" class="form-control radius2" name="radius2">
                            </div>
                        </div>
                    </div>
            </div>
            <div class="modal-footer">
                <!--<button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>-->
                <button type="button" class="btn btn-primary accept">Создать</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="sphereModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title">Создать паралепипед</h4>
            </div>
            <div class="modal-body">
                <div class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Радиус</label>
                        <div class="col-sm-10">
                            <input placeholder="0" class="form-control radius" name="radius">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <!--<button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>-->
                <button type="button" class="btn btn-primary accept">Создать</button>
            </div>
        </div>
    </div>
</div>


<!-- PAGE START PAGE START PAGE START PAGE START PAGE START PAGE START PAGE START PAGE START PAGE START -->
<!-- PAGE START PAGE START PAGE START PAGE START PAGE START PAGE START PAGE START PAGE START PAGE START -->
<!-- PAGE START PAGE START PAGE START PAGE START PAGE START PAGE START PAGE START PAGE START PAGE START -->
<!-- PAGE START PAGE START PAGE START PAGE START PAGE START PAGE START PAGE START PAGE START PAGE START -->

<nav class="navbar navbar-default">
    <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <a class="navbar-brand" href="#">ИГЭУ САПР</a>
        </div>
        <p class="navbar-text navbar-right">© Игорь Майоров</p>
    </div><!-- /.container-fluid -->
</nav>
<div class="container">
    <div class="row">
        <button data-toggle="modal" data-target="#cubeModal" class="btn btn-default btn-lg" type="submit"><i class="flaticon-rectangular"></i></button>
        <button data-toggle="modal" data-target="#cylinderModal" class="btn btn-default btn-lg" type="submit"><i class="flaticon-cylinder"></i></button>
        <button data-toggle="modal" data-target="#coneModal" class="btn btn-default btn-lg" type="submit"><i class="flaticon-cone"></i></button>
        <button data-toggle="modal" data-target="#sphereModal" class="btn btn-default btn-lg" type="submit"><i class="flaticon-sphere"></i></button>
        <div class="arrows" style="display: none">
            <button direction="left" class="btn btn-info btn-lg"><i class="glyphicon glyphicon-arrow-left"></i></button>
            <button direction="right" class="btn btn-info btn-lg"><i class="glyphicon glyphicon-arrow-right"></i></button>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="row" id="drawing"></div>
        </div>
        <div class="col-md-6">
            <div class="row" id="modeling"></div>
        </div>
    </div>

</div>
<script>

    //  Конвертация CSG фигуры в GL.Mesh объект.
    CSG.prototype.toMesh = function() {
        var mesh = new GL.Mesh({ normals: true, colors: true });
        var indexer = new GL.Indexer();
        this.toPolygons().map(function(polygon) {
            var indices = polygon.vertices.map(function(vertex) {
                vertex.color = polygon.shared;
                return indexer.add(vertex);
            });
            for (var i = 2; i < indices.length; i++) {
                mesh.triangles.push([indices[0], indices[i - 1], indices[i]]);
            }
        });
        mesh.vertices = indexer.unique.map(function(v) { return [v.pos.x, v.pos.y, v.pos.z]; });
        mesh.normals = indexer.unique.map(function(v) { return [v.normal.x, v.normal.y, v.normal.z]; });
        mesh.colors = indexer.unique.map(function(v) { return v.color; });
        mesh.computeWireframe();
        return mesh;
    };
    CSG.prototype.setColor = function(arr) {
        this.toPolygons().map(function(polygon) {
            polygon.shared = arr;
        });
    };

    // Зададим параметры
    var colors = [['#fff', '#000']/*,['#2ecc71','#27ae60'],['#3498db','#2980b9'],['#9b59b6','#8e44ad'],['#34495e', '#2c3e50']*/];
    var border_width = 2;
    var axisPadding = 7;
    var paddingBetweenAxis = 4;
    var window_width = $('#drawing').width();

    // Задаем переменные
    // 2D
    var elems = []; // Массив, в котором будет хранится вся инфа о имеющихся элементах на странице. Есть идея все это сеарилизировать на сервере
    var draw;

    // 3D
    var gl, mesh, lightingShader, scene;
    var angleX = 0, angleY = 0, depth = 15;
    function getRandomColor3d(){
        return [Math.random(), Math.random(), Math.random()];
    }

    function Scene(){
        var pr = 100; // маштаб сцены
        var self = this;
        this.mesh = null;
        this.solid = null;

        this.addCube = function(values, total_width, direction){
            var cube = CSG.cube({
                center: [(total_width*2)/pr, 0, 0],
                radius: [values.width/pr, values.height/pr, values.depth/pr]
            });
            cube.setColor(getRandomColor3d());
            if(this.solid){
                this.solid = this.solid.union(cube);
            } else {
                this.solid = cube;
            }
            renderMesh(this.solid);
        }

/*        this.substrCube = function(values, elem_id){

            var cube = CSG.cube({
                center: [, 0, 0],
                radius: [values.width/pr, values.height/pr, values.depth/pr]
            });
        }*/
        function addSphere(values, total_width, direction){
            return 0;
        }
        function addCone(values, total_width, direction){
            //Добавляем конус
            return 0;
        }

        function renderMesh(mesh){
            self.mesh = mesh.toMesh();
            gl.ondraw();
            return 0;
        }
    }

    // Инициализируем 2D SVG поле
    draw = SVG('drawing').size($('#drawing').width(), $('#drawing').width());
    gl = GL.create();
    gl.canvas.height = window_width;
    gl.canvas.width = window_width;
    gl.viewport(0, 0, window_width, window_width); // точка обзора
    gl.matrixMode(gl.PROJECTION);
    gl.loadIdentity();
    gl.perspective(45, 1, 0.1, 100);
    gl.matrixMode(gl.MODELVIEW);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
    gl.clearColor(0.93, 0.93, 0.93, 1);
    gl.enable(gl.DEPTH_TEST);
    gl.enable(gl.CULL_FACE);
    gl.polygonOffset(1, 1);
    lightingShader = new GL.Shader('\
        varying vec3 color;\
        varying vec3 normal;\
        varying vec3 light;\
        void main() {\
          const vec3 lightDir = vec3(1.0, 2.0, 3.0) / 3.741657386773941;\
          light = (gl_ModelViewMatrix * vec4(lightDir, 0.0)).xyz;\
          color = gl_Color.rgb;\
          normal = gl_NormalMatrix * gl_Normal;\
          gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;\
        }\
      ', '\
        varying vec3 color;\
        varying vec3 normal;\
        varying vec3 light;\
        void main() {\
          vec3 n = normalize(normal);\
          float diffuse = max(0.0, dot(light, n));\
          float specular = pow(max(0.0, -reflect(light, n).z), 32.0) * sqrt(diffuse);\
          gl_FragColor = vec4(mix(color * (0.3 + 0.7 * diffuse), vec3(1.0), specular), 1.0);\
        }\
     '
    );
    gl.onmousemove = function(e) {
        if (e.dragging) {
            angleY += e.deltaX * 2;
            angleX += e.deltaY * 2;
            angleX = Math.max(-90, Math.min(90, angleX));
            gl.ondraw();
        }
    };
    $('#modeling').html(gl.canvas);
    gl.ondraw = function() {
        gl.makeCurrent();
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
        gl.loadIdentity();
        gl.translate(0, 0, -depth);
        gl.rotate(angleX, 1, 0, 0);
        gl.rotate(angleY, 0, 1, 0);
        if(scene.mesh){
            gl.enable(gl.POLYGON_OFFSET_FILL);
            lightingShader.draw(scene.mesh, gl.TRIANGLES);
            gl.disable(gl.POLYGON_OFFSET_FILL);
        }
    }

    scene = new Scene();
    gl.ondraw();



    // Получаем рандомный цвет
    function getRandomColor(){
        return colors[Math.floor(Math.random() * (colors.length))];
    }

    // Находим использованное модальное окно на основе closest
    function getClosestModal(e){
        return $(e).closest('.modal');
    }

    // Получаем значения из модального окна в объекте
    function getValuesFromModal(e){
        var obj = new Object();
        getClosestModal(e).find('input').each(function(){
            obj[$(this).attr('name')] = parseInt($(this).val());
            $(this).val('');
        });
        return obj;
    }
    // Получаем общую ширину всех элементов
    function getTotalWidth() {
        total_width = 0;
        $.each(elems, function(i, e){
            total_width += e.values.width;
        });
        return total_width;
    }

    function getDashLength(width){ //  Подбор длины штриха осевой под коффициент 6 - типо крутая САПР, как компасс
        var i = 1;
        var length = false;
        while(length > 16 || !length){
            i++;
            length = ((width + 4 + axisPadding*2)/i - 4);
            console.log(length + ' | ' + i);
        }
        return length;
    }

    // Двигаем элементы
    function moveElems(width, direction){
        $.each(elems, function(i, e){
            e.object2d.dx((parseInt(width))/2 * -1 * direction);
        });
        gl.loadIdentity();
        gl.translate(30,0,0)
    }

    // Добавляем куб

//    scene.addCube({width: 100, height:100, depth:100}, 0);
//    scene.addCube({width: 100, height:100, depth:100}, 100);
//    scene.addCube({width: 100, height:100, depth:100}, 300);
    // Добавляем квадрат
    function addRect(values, total_width, direction, withAxis) {
        var randColor = getRandomColor();
        var group = draw.group()
        group.add(draw.rect(values.width - border_width/2, values.height - border_width/2)
                .fill(randColor[0])
                .stroke({linecap: 'square', color: randColor[1], width: border_width})
                .x((total_width * direction + (elems.length > 0 ? border_width * -1 * direction : 0) + window_width - values.width )/2)
                .y((window_width - values.height + border_width)/2));
        if(withAxis){
            group.add(
                    draw.line((total_width + window_width - values.width )/2 - axisPadding, window_width/2, (total_width + window_width - values.width )/2 + values.width + axisPadding, window_width/2)
                            .stroke({width: border_width/2, color: '#e67e22', dasharray: getDashLength(values.width - border_width/2) + ', 4'})
            );
        }
        return group;
    }

    function addCircle(values, total_width, direction){
        var randColor = getRandomColor();
        var group = draw.group()
        group.add(draw.circle(values.radius*2)
                .x((total_width * direction + window_width - (values.radius*2 - (elems.length > 0 ? 0 : border_width * -1 * direction)))/2)
                .y((window_width - (values.radius*2 - border_width))/2)
                .fill(randColor[0])
                .stroke({linecap: 'square', color: randColor[1], width: border_width}));
        group.add(
                draw.line(
                        window_width/2,
                        (total_width + window_width - values.width )/2 - axisPadding,
                        window_width/2,
                        (total_width + window_width - values.width )/2 + values.width + axisPadding

                )
                        .stroke({width: border_width/2, color: '#e67e22', dasharray: getDashLength(values.width - border_width/2) + ', 4'})
        );
        group.add(
                draw.line((total_width + window_width - values.width )/2 - axisPadding, window_width/2, (total_width + window_width - values.width )/2 + values.width + axisPadding, window_width/2)
                        .stroke({width: border_width/2, color: '#e67e22', dasharray: getDashLength(values.width - border_width/2) + ', 4'})
        );
        return group;
    }

    // Добавляем полигон / трапецию
    function addPolygone(values, total_width, direction){
        var randColor = getRandomColor();
        var coord = [];
        var group = draw.group()
        if(values.radius2 != 0){
            coord.push([(total_width * direction + window_width - (values.width - (elems.length > 0 ? 0 : border_width * direction)))/2, (window_width + (values.radius2*2 - (values.radius1 == 0 ? border_width : 0)))/2]);
        }
        coord.push([(total_width * direction + window_width - (values.width - (elems.length > 0 ? 0 : border_width * direction)))/2, (window_width - (values.radius2*2 - (values.radius1 == 0 ? border_width*2 : 0)/* */))/2]);
        coord.push([(total_width * direction + window_width + (values.width - (elems.length > 0 ? 0 : border_width * direction)))/2, (window_width - (values.radius1*2 - (values.radius2 == 0 ? border_width : 0) /* + border_width*2*/))/2]);

        if(values.radius1 != 0){
            coord.push([(total_width * direction + window_width + (values.width - (elems.length > 0 ? 0 : border_width * direction)))/2, (window_width + (values.radius1*2 - (values.radius2 == 0 ? border_width : 0)))/2]);
        }
        group.add(draw.polygon(coord).fill(randColor[0])
                .stroke({linecap: 'square', color: randColor[1], width: border_width}));
        group.add(draw.line((total_width * direction + window_width - values.width)/2 - axisPadding, window_width/2, (total_width * direction + window_width - values.width)/2 + values.width + axisPadding, window_width/2)
                .stroke({width: border_width/2, color: '#e67e22', dasharray: getDashLength(values.width - border_width/2) + ', 4'}))
        return group;
    }
    
    $('.btn.accept').click(function(){
        getClosestModal(this).modal('hide'); // Закрываем модальное окно
        var values = getValuesFromModal(this); // Получаем данные из модального окна
        var action = getClosestModal(this).attr('id'); // Получаем че это вообще за модальное окно было
        var object;
        $('.arrows').show(); // Показываем стрелочки
        $('.arrows button').click(function(){ // вешаем событие на клик по стрелочке
            $('.arrows').hide(); // Скрываем стрелочки
            var direction = $(this).attr('direction') == 'right' ? 1 : -1; // Вычисляем направление
            total_width = getTotalWidth(); // Получаем общую ширину
            moveElems(values.width, direction); // Двигаем элементы в сторону
            switch(action){ // Тут понятно, выбираем действие/фигуру
                case 'cubeModal': // Кубик
                    object = [addRect(values, total_width, direction), scene.addCube(values, total_width, direction)]; break;
                case 'cylinderModal': // Цилиндр
                        values.radius2 = values.radius1;
                        values.height = values.radius2 * 2;
                    object = [addRect(values, total_width, direction, true), addCone(values, total_width, direction)]; break;
                case 'coneModal':
                    object = [addPolygone(values, total_width, direction), addCone(values, total_width, direction)]; break;
                case 'sphereModal':
                    values.width = values.radius * 2;
                    object = [addCircle(values, total_width, direction), addSphere(values, total_width, direction)]; break;
                default:
                    false;
            }
            elems.push({
                object2d: object[0], // Добавляем квадрат
                object3d: object[1], // Добавляем куб
                values: values // запоминаем размеры, для оптимизации и быстродействия
            });

            $('.arrows button').unbind(); // Убиваем событие на стрелочки
        });
        if(elems.length < 1){ // если создаем первый элемент,
            $('.arrows button:first-child').click(); // то кликаем на первую попавшуюся стрелочку программой,
        } // нахрена ее тыкать человеку
    });



</script>
</body>
</html>